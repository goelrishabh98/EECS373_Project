void begin(){

	uint8_t cmd, x, numArgs;
	const uint8_t *addr = initcmd;

	MSS_SPI_init(&g_mss_spi1);
	configureSPI(8);

	sendCommand(SWRESET);
	delay(150)
	while((cmd = read_byte(addr++))){
		x = read_byte(addr++);
		numArgs = x & 0x7F;
		sendCommand(cmd, addr, numArgs);
		addr += numArgs;
		if(x & 0x80){
			delay(150);
		}
	}
}

void drawPixel(uint16_t x, uint16_t y, uint16_t color){
	setAddr(x, y, x, y);
	sendCommand(ILI9341_RAMWR, color)
}


void drawRectangle(uint16_t x, uint16_t y, uint16_t w, uint16_t h, uint16_t color){
	setAddr(x, y, x+w-1, y+h-1);
	sendCommand(ILI9341_RAMWR);

	for(y=h; y>0; y--){
		for(x = w; x>0; x--){
			sendData(color);
		}
		sendData(color);
	}
}	

void drawFillScreen(uint16_t color){
	drawRectangle(0, 0, x+ILI9341_WIDTH-1, y-ILI9341_HEIGHT-1, color);
}
void setAddr(uint16_t x0, uint16_t y0, uint16_t x1, uint16_t y1){
	
	sendCommand(ILI9341_CASET);
	sendData(x0);
	sendData(x1);
	sendCommand(ILI9341_PASET);
	sendData(y0);
	sendData(y1);
}

void sendCommand(uint8_t commandByte, uint8_t *dataBytes, uint8_t numDataBytes){

	set_SPI_CS();
	set_DC_LOW();
	sendSPI(&commandByte);

	set_DC_HIGH();
	for(int i=0; i<numDataBytes; i++){
		sendSPI(*dataBytes);
		dataBytes++;
	}
	clear_SPI_CS();
}

void sendCommand(uint8_t commandByte, uint16_t dataBytes){

	set_SPI_CS();
	set_DC_LOW();
	configureSPI(16);

	sendSPI(&commandByte);

	set_DC_HIGH();
	for(int i=0; i<numDataBytes; i++){
		sendSPI(*dataBytes);
		dataBytes++;
	}
	clear_SPI_CS();
}

void delay(uint32_t time){

	uint32_t start = MSS_TIM1_get_current_value();
	uint32_t val = start - (int)(time/0.01);

	MSS_TIM1_start();
	while(MSS_TIM1_get_current_value()>val){
		//do nothing
	}
	MSS_TIM1_stop();
}

void configureSPI(uint8_t frameSize){
	MSS_SPI_configure_master_mode(
		&g_mss_spi1, 
		MSS_SPI_SLAVE_0,
		MSS_SPI_MODE0,
		MSS_SPI_PCLK_DIV_16,
		frameSize
	);
}

void sendSPI(uint8_t *data){
	
	MSS_SPI_transfer_frame( &g_mss_spi1, *data);
	
}

void set_SPI_CS(){
	MSS_SPI_set_slave_select(&g_mss_spi1, MSS_SPI_SLAVE_0);
}

void clear_SPI_CS(){
	MSS_SPI_clear_slave_select( &g_mss_spi1, MSS_SPI_SLAVE_0 );
}

